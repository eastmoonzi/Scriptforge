📐 Prompt 设计的整体架构

  这个项目采用了 分层、模块化、可组合 的 Prompt 设计策略：

  ┌─────────────────────────────────────────────┐
  │         第一层：基础角色 Prompt              │
  │     (app.py + agent_crew.py)                │
  │  - 角色身份和性格                            │
  │  - 场景和上下文                              │
  │  - 记忆系统（群聊+私聊）                      │
  │  - 行为规则                                  │
  └─────────────────────────────────────────────┘
                      ↓
  ┌─────────────────────────────────────────────┐
  │       第二层：Few-shot 增强 Prompt           │
  │     (template_manager.py)                   │
  │  - 剧本风格特征（悬疑/喜剧/现实主义）         │
  │  - 专业话剧术语                              │
  │  - 正反示例对比                              │
  └─────────────────────────────────────────────┘
                      ↓
  ┌─────────────────────────────────────────────┐
  │       第三层：管理层 Prompt                  │
  │     (director_system.py)                    │
  │  - 编剧：剧情规划                            │
  │  - 导演：任务分配                            │
  │  - 审核：质量检查                            │
  └─────────────────────────────────────────────┘

  ---
  🎯 第一层：基础角色 Prompt

  设计目标

  - 让 AI 明确自己的身份和性格
  - 提供完整的上下文信息
  - 指导 AI 如何利用记忆系统
  - 约束输出格式

  核心结构（app.py:573-649）

  prompt = f"""
  你正在扮演角色：{character['name']}（性格：{character['personality']}）
  场景：{scene}

  所有角色：
  {characters_text}

  【你的记忆系统】
  你拥有两种记忆：

  1. 群聊记录（所有人都能看到的公开对话）：
  {group_text}

  2. 私聊记录（只有你知道的私密信息）：
  {private_text}

  请以{character['name']}的身份和性格，{"在私聊中回应用户" if is_private else "在群聊中发言"}。

  【重要提示】
  - 仔细阅读你的完整记忆（群聊+私聊），统揽全局
  - 你可以自由选择回应的对象和方式
  - **关键**：你可以利用私聊中获得的信息，但要注意：
    * 不要直接泄露私聊内容（其他人不知道）
    * 可以巧妙地暗示或利用这些信息
    * 让你的发言更有深度和策略性
  - 你的发言要基于对整个记忆的理解，而不是只看最后一条消息
  - 充分展现你的性格特点
  - 只输出你要说的一句话，不要加角色名

  你的发言：
  """

  设计亮点

  ✅ 1. 双记忆系统的设计

  群聊记录：公开信息，所有人可见
  私聊记录：私密信息，只有该角色知道

  关键指令：
  - "可以利用私聊信息" → 鼓励策略性发言
  - "但不要直接泄露" → 防止信息泄露
  - "可以巧妙暗示" → 增加对话深度

  为什么这么设计？
  - 模拟真实的人际交往（公开场合 vs 私下交流）
  - 增加角色的策略性和复杂度
  - 避免对话过于直白和浅层

  实际效果示例：
  # 私聊中用户告诉法师："勇士害怕黑暗"

  # 群聊中，法师不会直接说：
  法师：勇士，我知道你害怕黑暗。❌

  # 而是会巧妙暗示：
  法师：这个山洞太黑了，我们点个火把吧，毕竟...有些人可能需要更多光亮。✅

  ✅ 2. "统揽全局"的指令

  - 仔细阅读你的完整记忆（群聊+私聊），统揽全局
  - 你的发言要基于对整个记忆的理解，而不是只看最后一条消息

  为什么？
  - 早期版本发现 AI 只关注最后一条消息
  - 导致对话缺乏连贯性
  - "统揽全局"明确要求 AI 考虑整体对话流

  ✅ 3. 自由度的控制

  - 你可以自由选择回应的对象和方式：
    * 回应用户的发言
    * 回应任何一个角色说的话
    * 对之前提到的话题进行补充或延伸
    * 综合多个人的观点给出你的看法
    * 提出与对话相关的新想法

  设计思路：
  - 给予 AI 足够的发言自由度
  - 避免僵化的"只回应上一个人"
  - 鼓励多角度、跨话题的互动

  ✅ 4. 严格的输出格式约束

  - 只输出你要说的一句话，不要加角色名，不要有其他说明

  为什么？
  - 防止 AI 输出多余的解释（如："作为法师，我觉得..."）
  - 保持对话的自然流畅
  - 方便后续解析和显示

  ---
  🎭 CrewAI 架构中的 Prompt 设计

  Agent 的 Backstory（agent_crew.py:54-65）

  backstory = f"""
  你是 {char['name']}，性格特点：{char['personality']}

  当前场景：{self.scene}

  你的行为准则：
  1. 始终保持你的性格特点
  2. 根据对话上下文做出真实反应
  3. 可以主动提出话题或回应其他人
  4. 如果你有私聊记忆，可以巧妙利用但不要直接泄露
  5. 让对话自然流畅
  """

  CrewAI 的 Prompt 特点：
  - 使用 backstory 定义角色背景和行为准则
  - 使用 goal 定义明确的任务目标
  - Agent 会自动保留对话历史（memory=True）

  Task 的 Description（agent_crew.py:119-149）

  CrewAI 的 Task 分为两种情况：

  情况1：有用户输入

  task_description = f"""
  {context}

  作为 {agent.role}，用户刚才说了话，请决定如何回应：
  1. 你是否想对用户的话做出回应？
  2. 如果回应，你想说什么？

  规则：
  - 用户刚才说："{user_message}"
  - 你应该认真考虑用户的话，并根据你的性格和记忆做出回应
  - 如果你觉得这轮不适合发言，可以保持沉默（输出：PASS）
  - 如果要发言，直接输出你想说的话（一句话，不要加角色名）
  """

  关键设计：
  - 给予 Agent "选择沉默"的能力（输出 PASS）
  - 避免强制所有角色都发言（更真实）

  情况2：自主对话

  task_description = f"""
  {context}

  作为 {agent.role}，这是一轮自主对话（没有用户输入），请决定：
  1. 你是否想在这轮对话中发言？
  2. 如果发言，你想说什么？

  规则：
  - 如果你觉得没有必要发言，可以保持沉默（输出：PASS）
  - 如果要发言，直接输出你想说的话
  - 可以主动提出话题，或回应其他角色
  """

  设计思路：
  - 避免机械轮流发言（Bad Case 库中的典型问题）
  - 让 AI 自主判断是否需要发言
  - 模拟真实的群聊场景（不是每个人每次都说话）

  ---
  🎨 第二层：Few-shot 增强 Prompt

  设计目标

  - 通过示例引导 LLM 学习特定风格
  - 提供专业话剧术语
  - 展示正反对比（好的 vs 坏的）

  核心结构（template_manager.py:151-207）

  enhanced_prompt = f"""
  你正在扮演角色：{character['name']}（性格：{character['personality']}）
  场景：{scene}

  【风格要求：{template.get('template_name')}】
  • 语气：{tone}
  • 推荐词汇：{', '.join(vocabulary[:5])}
  • 句式参考：{', '.join(sentence_patterns[:2])}

  {few_shot_text}  # 这里插入完整的 Few-shot 示例

  【重要提示】
  - 严格保持你的性格特点
  - 参考上述示例的对话风格和节奏
  - 让对话自然、有深度、符合话剧表现形式

  {base_prompt}

  你的发言：
  """

  Few-shot 示例的结构（templates/drama_suspense.json）

  {
    "template_name": "悬疑话剧风格",
    "language_features": {
      "vocabulary": ["线索", "疑点", "破绽", "真相", "疑云"],
      "sentence_patterns": [
        "这件事有蹊跷...",
        "我注意到一个细节...",
        "等等，你刚才说的话有破绽"
      ],
      "tone": "谨慎、试探、暗示"
    },
    "few_shot_examples": [
      {
        "scene": "密室谋杀案现场，三位侦探在调查",
        "characters": {...},
        "dialogue": [
          {
            "speaker": "老探长",
            "content": "现场有三个烟蒂，但受害者不抽烟...这说明凶手在这里等了很久。",
            "analysis": "✅ 从细节推理，符合「细心」人设"
          },
          ...
        ],
        "key_techniques": [
          "信息层层递进：从物证→推理→新疑点",
          "角色分工明确：观察者、推理者、验证者"
        ]
      }
    ],
    "anti_patterns": [
      {
        "bad_example": "这里有个烟蒂。",
        "issue": "缺少推理过程，信息密度低",
        "good_alternative": "现场有三个烟蒂，但受害者不抽烟...凶手在这里等了很久。"
      }
    ]
  }

  Few-shot 的设计亮点

  ✅ 1. 语言特征提取

  vocabulary: 专业术语词汇表
  sentence_patterns: 典型句式模板
  tone: 语气风格定义

  作用：
  - 快速建立风格印象
  - 提供具体的语言工具

  ✅ 2. 完整对话示例

  - 不是单句示例，而是多轮对话
  - 展示角色间的互动关系
  - 附带 analysis 说明为什么这么写

  为什么用多轮对话？
  - 单句示例无法体现对话节奏
  - 多轮对话展示"层层递进"的技巧
  - 让 AI 学习对话的整体结构

  ✅ 3. 关键技巧总结

  "key_techniques": [
    "信息层层递进：从物证→推理→新疑点",
    "角色分工明确：观察者、推理者、验证者",
    "悬念营造：提出问题但不立即解答"
  ]

  作用：
  - 提炼可复用的创作技巧
  - 帮助 AI 理解"为什么"而不只是"是什么"

  ✅ 4. 反面示例对比

  "anti_patterns": [
    {
      "bad_example": "这里有个烟蒂。",
      "issue": "缺少推理过程，信息密度低",
      "good_alternative": "现场有三个烟蒂，但受害者不抽烟...凶手在这里等了很久。"
    }
  ]

  设计思路：
  - 告诉 AI "不要这么做"
  - 正反对比，加深理解
  - 直接针对 Bad Case 库中的问题

  ---
  🎬 第三层：管理层 Prompt（Director System）

  编剧 Agent Prompt（director_system.py:64-75）

  backstory = f"""
  你是一位经验丰富的话剧编剧，擅长：
  1. 剧情设计：根据当前对话状态，规划下一步剧情发展
  2. 冲突制造：让角色之间产生有趣的矛盾和碰撞
  3. 节奏把控：知道何时推进情节，何时留白
  4. 伏笔埋设：在对话中暗藏线索，为后续发展做铺垫

  当前场景：{self.scene}
  角色：{', '.join([c['name'] for c in self.characters])}

  你的任务是：为每一轮对话设计明确的剧情目标。
  """

  Task Prompt：
  f"""
  {context}

  作为编剧，你需要为这一轮对话设计明确的剧情目标。

  思考：
  1. 当前剧情处于什么阶段？（开场/发展/高潮/收尾）
  2. 需要制造什么样的冲突或悬念？
  3. 是否需要埋伏笔或推进已有线索？
  4. 本轮对话的情感基调是什么？（紧张/轻松/沉重/幽默）

  请用1-2句话描述本轮对话的剧情目标。
  """

  设计特点：
  - 宏观视角（不关心具体台词，只关心剧情走向）
  - 四个思考维度引导 AI 进行剧情设计
  - 输出简洁（1-2句话），便于后续使用

  导演 Agent Prompt（director_system.py:86-100）

  backstory = f"""
  你是一位资深话剧导演，负责：
  1. 节奏控制：决定本轮对话的快慢、紧张度
  2. 发言分配：根据剧情需要，决定哪些角色发言
  3. 氛围营造：通过指导语，帮助角色进入状态
  4. 矛盾激化：鼓励角色间的真实互动和冲突

  你的任务是：根据编剧的剧情目标，为每个需要发言的角色提供明确的发言指示。
  """

  Task Prompt：
  f"""
  {context}

  编剧的剧情目标：{plot_goal}

  作为导演，你需要：
  1. 决定本轮哪些角色需要发言（可以是全部，也可以只选几个）
  2. 为每个发言的角色提供明确的指示：
     - 发言方向：应该说什么类型的内容
     - 态度/语气：用什么样的态度
     - 与其他角色的关系：是支持、反对、还是中立

  输出格式（JSON）：
  {{
    "selected_characters": ["角色1", "角色2"],
    "instructions": {{
      "角色1": "发言指示...",
      "角色2": "发言指示..."
    }}
  }}
  """

  设计特点：
  - 承接编剧的宏观目标，转化为具体指令
  - 动态选择角色（不必全员发言）
  - 输出结构化（JSON），便于程序解析

  审核 Agent Prompt（director_system.py:108-123）

  backstory = f"""
  你是一位严格的戏剧评论家，负责质量把关：
  1. OOC 检测：检查角色发言是否符合人设
  2. 逻辑审查：对话是否合理、前后是否矛盾
  3. 深度评估：对话是否有实质内容，还是流于表面
  4. 节奏判断：对话推进是否合理

  你的任务是：审查生成的对话，给出"通过/重做"的判断和具体建议。
  """

  Task Prompt：
  f"""
  编剧的剧情目标：{plot_goal}
  导演的分配计划：{director_plan}
  实际生成的对话：{dialogue_text}

  作为审核，请检查：
  1. ✅ 角色是否符合人设（有无 OOC）
  2. ✅ 对话是否推进了剧情目标
  3. ✅ 对话是否有实质内容（不是空话套话）
  4. ✅ 角色间的互动是否自然

  输出格式（JSON）：
  {{
    "pass": true/false,
    "feedback": "具体反馈...",
    "scores": {{
      "character_consistency": 0-10,
      "plot_advancement": 0-10,
      "content_quality": 0-10,
      "interaction_nature": 0-10
    }}
  }}
  """

  设计特点：
  - 四个维度的量化评估
  - 明确的"通过/不通过"判断
  - 提供具体反馈（用于重试时改进）

  ---
  🎯 Prompt 设计的核心原则

  1. 清晰的身份定义

  你是 {角色名}，性格：{性格特点}
  - 第一句话必须明确身份
  - 性格特点具体化（不是"好人"，而是"勇敢、冲动、直率"）

  2. 完整的上下文

  场景 + 角色列表 + 对话历史 + 用户输入
  - 提供所有必要信息
  - 避免 AI "猜测"背景

  3. 明确的行为指令

  【重要提示】
  - 做什么
  - 不做什么
  - 如何做
  - 使用列表形式
  - 正面指令 + 负面约束

  4. 严格的输出格式

  只输出你要说的一句话，不要加角色名
  - 最后一句必须说明输出格式
  - 防止 AI 输出多余内容

  5. 分层可组合

  基础 Prompt → 加 Few-shot → 加管理层
  - 每一层独立设计
  - 可选择性叠加
  - 向下兼容

  ---
  📊 Prompt 设计的演进历史

  v1.0：朴素 Prompt

  f"你是{name}，性格{personality}，说一句话"
  问题：
  - 角色趋同
  - 机械轮流
  - 缺乏深度

  v2.0：加入记忆系统

  f"""
  你是{name}，性格{personality}
  场景：{scene}
  历史对话：{history}
  请发言
  """
  改进：
  - 有了上下文
  - 但仍然机械

  v3.0：CrewAI + 双记忆

  # Agent backstory + Task description
  # 群聊记忆 + 私聊记忆
  # "统揽全局" + "可以选择沉默"
  改进：
  - 自主决策
  - 策略性发言
  - 记忆隔离

  v3.3：加入 Few-shot 模版

  # 基础 Prompt + Few-shot 示例 + 专业术语
  改进：
  - 风格化
  - 专业化
  - 可控性增强

  v3.4（实验）：管理层架构

  # 编剧规划 → 导演分配 → 角色执行 → 审核检查
  改进：
  - 质量保证
  - 灵活选角
  - 可观测性

  ---
  💡 为什么这么设计？

  问题驱动的设计

  | 问题         | 解决方案      | Prompt 技巧                          |
  |--------------|---------------|--------------------------------------|
  | 角色趋同     | 强化性格特点  | "严格保持你的性格特点"               |
  | 机械轮流     | 允许沉默      | "如果不适合发言，输出PASS"           |
  | 只看最后一条 | 统揽全局      | "基于完整记忆理解，不是只看最后一条" |
  | 泄露私聊     | 明确约束      | "可以利用但不要直接泄露"             |
  | 缺少深度     | Few-shot 引导 | 提供多轮对话示例                     |
  | OOC 问题     | 管理层审核    | 审核 Agent 检查人设一致性            |

  ---
  这就是整个项目的 Prompt 设计哲学！核心思想是：通过精细化的 Prompt 工程，让 AI 像真实的话剧演员一样表演。 🎭
