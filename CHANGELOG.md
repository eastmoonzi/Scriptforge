# 版本更新日志

## v3.0.0 - 2026-01-07

### 🚀 重大架构升级：真正的多智能体系统

本次更新是**架构级别的重大升级**，将系统从"基于 Prompt 的角色扮演"（v2.x）升级为**基于 CrewAI 框架的真正多智能体系统**（v3.x）。

---

### 核心变革

#### 从伪 Agent 到真 Agent

**之前（v2.2.0）：**
```python
for char in characters:
    # 同一个 LLM，不同 prompt
    response = call_gemini(f"你是{char}，请回应")
```
- 本质：角色扮演
- 实现：顺序调用同一个 API
- 决策：被动，按固定顺序发言

**现在（v3.0.0）：**
```python
# 使用 CrewAI 框架
agents = [Agent(role=char, ...) for char in characters]
crew = Crew(agents=agents)
result = crew.kickoff()  # Agent 自主协作
```
- 本质：真正的 Multi-Agent System
- 实现：基于 CrewAI 框架
- 决策：主动，Agent 自己决定是否发言

---

### 新增功能

#### 1. CrewAI 多 Agent 系统 ⭐⭐⭐⭐⭐

**核心特性：**
- ✅ 每个角色是独立的 CrewAI Agent
- ✅ Agent 自主决定是否发言（不是每次都说话）
- ✅ 基于完整记忆（群聊+私聊）做智能决策
- ✅ 真正的协作机制

**文件：**
- `agent_crew.py`：CrewAI 封装层
- `CREWAI_GUIDE.md`：详细使用指南

#### 2. 智能发言决策

**场景示例：**
```
用户："大家觉得怎么样？"

CrewAI 执行：
  Agent A: "我同意！" （主动发言）
  Agent B: PASS （选择沉默）
  Agent C: "我也觉得可以" （主动发言）

结果：只有 A 和 C 回应（B 觉得没必要说）
```

**传统模式：** A、B、C 都会机械地发言

#### 3. 双模式支持

**CrewAI 模式：**（默认，推荐）
- 真正多 Agent
- 智能决策
- 对话自然

**传统模式：**
- 顺序发言
- 保证每个角色都参与
- 兼容旧版本

**切换方式：**
- 侧边栏勾选"🤖 启用 CrewAI 多 Agent 系统"

#### 4. 自动降级机制

- CrewAI 执行失败时自动切换到传统模式
- 保证服务可用性
- 对用户透明

---

### 技术架构

#### 依赖变更

**新增：**
```bash
crewai >= 0.1.0
langchain-google-genai >= 0.1.0
```

**Python 要求：**
```bash
Python >= 3.10  # CrewAI 要求
```

#### 架构对比

```
v2.2.0 架构：
用户输入 → 角色A(Gemini) → 角色B(Gemini) → 角色C(Gemini)
          （顺序调用）

v3.0.0 架构：
用户输入 → CrewAI Crew
             ├─ Agent A (独立决策)
             ├─ Agent B (独立决策)
             └─ Agent C (独立决策)
          → 协作结果
```

#### 核心代码

**CharacterAgentCrew 类：**
```python
class CharacterAgentCrew:
    def __init__(self, scene, characters, api_key):
        # 创建 CrewAI Agents
        self.agents = [
            Agent(role=char['name'],
                  goal=...,
                  backstory=char['personality'],
                  llm=Gemini)
            for char in characters
        ]

    def run_conversation_round(self, user_message):
        # 让 Agents 协作完成对话任务
        ...
```

---

### UI 改进

#### 侧边栏新增

1. **CrewAI 开关**
   ```
   ☑️ 启用 CrewAI 多 Agent 系统
   ✅ 真正多 Agent 模式
   ```

2. **状态提示**
   - CrewAI 可用：显示"真正多 Agent 模式"
   - 降级/未安装：显示"传统顺序模式"

#### 对话界面

- 状态提示：`🤖 多 Agent 系统正在协作...`
- 降级提示：自动切换时有错误提示

---

### 对比 v2.2.0

| 维度 | v2.2.0 | v3.0.0 |
|------|--------|--------|
| **架构** | 伪多 Agent | 真多 Agent（CrewAI） |
| **Agent 实例** | 无 | 独立 Agent 实例 ✅ |
| **发言决策** | 固定顺序 | 自主决策 ✅ |
| **框架** | 自研 | CrewAI ✅ |
| **行业认可** | - | 主流框架 ✅ |
| **可降级** | - | 自动降级 ✅ |
| **面试加分** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ ✅ |

---

### 实战示例

#### 场景：战术讨论

**用户：** "我们该往哪个方向走？"

**传统模式（v2.2.0）：**
```
勇士：我觉得应该往左走
法师：我同意往左走
盗贼：我也觉得往左走
```
（机械、重复）

**CrewAI 模式（v3.0.0）：**
```
勇士：往左！我打头阵！
法师：等等，让我先探测一下...
（盗贼保持沉默，观察环境）
```
（自然、有策略）

---

### 已知限制

1. **Python 版本要求**
   - 需要 Python >= 3.10
   - 旧环境需要升级

2. **API 调用**
   - CrewAI 每个 Agent 独立调用
   - 成本可能略高（但对话质量显著提升）

3. **不可预测性**
   - Agent 可能选择不发言
   - 如需保证每个角色都参与，使用传统模式

---

### 升级指南

#### 从 v2.2.0 升级

**1. 升级 Python（如需要）：**
```bash
python3 --version  # 检查版本
# 如果 < 3.10，需要升级
```

**2. 安装依赖：**
```bash
pip install crewai langchain-google-genai
```

**3. 运行：**
```bash
streamlit run app.py
```

**4. 配置：**
- 勾选"使用真实 Gemini API"
- 勾选"启用 CrewAI 多 Agent 系统"

#### 兼容性

- ✅ 支持加载 v2.2.0 的对话文件
- ✅ 支持加载 v2.1.x 的对话文件
- ✅ 预设文件完全兼容
- ✅ 可选择使用传统模式

---

### 面试展示建议

**话术示例：**

> "我的项目经历了三个架构阶段：
>
> v2.1：基于 Prompt 的角色扮演（单 LLM）
> v2.2：独立记忆管理（伪多 Agent）
> v3.0：集成 CrewAI 框架（真多 Agent）
>
> 选择 CrewAI 是因为它专为角色化 Agent 团队设计，相比 LangChain 的通用性和 AutoGen 的学术性，CrewAI 更贴近实际产品场景。
>
> 实现上，我封装了 CrewAI 的复杂性，提供了简单的 API，并设计了降级机制保证可用性。这体现了我的框架选型能力、架构设计能力和工程实践经验。"

**演示要点：**
1. 展示 Agent 自主决策（有的说，有的不说）
2. 展示私聊记忆在群聊中的巧妙利用
3. 展示自主对话的自然性
4. 对比传统模式和 CrewAI 模式的差异

---

### 相关文档

- `CREWAI_GUIDE.md`：详细使用指南
- `README.md`：项目总览
- `agent_crew.py`：CrewAI 封装实现

---

**这是一次从"模拟"到"真实"的质的飞跃！** 🚀

---

## v2.2.0 - 2026-01-06

### 🎉 重大架构升级：真正的多 Agent 系统

本次是架构级别的重大更新，从伪多 Agent 升级为**真正的多 Agent 系统**，每个角色拥有独立记忆，实现了真实的智能体交互。

### 核心变革 ⭐⭐⭐

#### 1. 真正的多 Agent 记忆系统

**之前的问题**：
- 群聊和私聊记忆完全分离
- 角色在群聊时看不到私聊内容
- 无法实现真实的"知情者"角色扮演

**v2.2.0 解决方案**：
```
每个角色的完整记忆 = 群聊历史 + 自己的私聊历史

角色 A 的记忆：[群聊1, 群聊2, 私聊A1, 群聊3, 私聊A2, ...]
角色 B 的记忆：[群聊1, 群聊2, 私聊B1, 群聊3, ...]
角色 C 的记忆：[群聊1, 群聊2, 群聊3, ...]  // 没有私聊
```

**效果**：
- ✅ 角色在群聊时会"记得"私聊内容
- ✅ 可以巧妙暗示或利用私密信息
- ✅ 其他角色不知道的私聊不会泄露
- ✅ 实现真正的"信息不对称"和策略性对话

#### 2. 角色自主对话功能 🎭

**新增功能**：
- 添加"🎭 继续聊"按钮
- 用户可设置角色自主对话的轮数（1-5轮）
- 角色们基于当前上下文自然延续话题
- 无需用户介入，角色自主推进对话

**使用场景**：
- 观察角色间的自然互动
- 让对话自然发展后再介入
- 探索角色性格碰撞

#### 3. 预设导入功能 📂

**新增功能**：
- 支持 JSON 格式的预设文件
- 一键加载场景、角色、API Key
- 快速开始，无需手动输入

**预设文件格式**：
```json
{
  "preset_name": "场景名称",
  "version": "2.2.0",
  "scene": "场景描述...",
  "api_key": "可选的API密钥",
  "characters": [
    {
      "name": "角色名",
      "personality": "性格描述..."
    }
  ]
}
```

**内置预设**：
- `preset_example_castle.json`: 古堡探险（奇幻冒险）
- `preset_example_startup.json`: 创业公司（现代商战）

### 技术细节

**新增核心函数**：
- `init_character_memories()`: 初始化角色记忆
- `add_group_message()`: 添加群聊消息（所有角色可见）
- `add_private_message()`: 添加私聊消息（仅指定角色可见）
- `get_character_memory()`: 获取角色完整记忆
- `get_private_messages()`: 获取角色私聊消息
- `load_preset_from_json()`: 加载预设文件

**数据结构变更**：
```python
# 旧架构（v2.1.x）
st.session_state.group_chat_history = []
st.session_state.private_chat_history = {角色: [...]}

# 新架构（v2.2.0）
st.session_state.shared_events = []  # 群聊事件流（显示用）
st.session_state.character_memories = {
    '角色A': [完整记忆...],
    '角色B': [完整记忆...],
}
```

**AI Prompt 优化**：
- 明确告知 AI 角色的两种记忆（群聊+私聊）
- 指导 AI 利用私聊信息但不直接泄露
- 提升对话的策略性和真实感

### 向后兼容

- ✅ 支持加载 v2.1.x 的对话文件
- ✅ 自动转换旧格式到新架构
- ✅ 保留所有旧功能

### UI 改进

- 群聊界面新增"继续聊"按钮和轮数选择
- 侧边栏新增"快速开始"区域（预设导入）
- 优化 API Key 管理（支持从预设加载）

### 对比 v2.1.1

| 特性 | v2.1.1 | v2.2.0 |
|------|--------|--------|
| 多 Agent 架构 | 伪多 Agent（分离记忆） | 真正多 Agent（独立记忆） |
| 私聊记忆 | 群聊时不可见 | 融合到角色完整记忆 |
| 信息不对称 | ❌ | ✅ |
| 角色自主对话 | ❌ | ✅（1-5轮可选） |
| 预设导入 | ❌ | ✅（JSON 格式） |
| 保存格式 | v2.1.x 格式 | v2.2.0 格式（向后兼容） |

### 实战示例

**场景：秘密告知**
1. 群聊："谁想听个秘密？"
2. 私聊角色A："其实我是卧底"
3. 回到群聊："刚才那个秘密记住了吗？"
4. **角色A**："我明白了...（暗示但不泄露）"  ✅
5. **角色B/C**："什么秘密？我不知道啊" ✅

**场景：角色自主对话**
1. 用户说："你们觉得这个计划怎么样？"
2. 点击"🎭 继续聊"，选择 3 轮
3. 角色们自主讨论计划，互相辩论
4. 用户观察后再介入引导方向

### 已知限制

- 对话历史较长时，记忆取最近 20 条（可优化）
- 预设文件必须是 JSON 格式
- 角色数量仍限制为 2-8 个

### 升级建议

**从 v2.1.x 升级**：
1. 直接运行新版本
2. 旧的保存文件会自动转换
3. 建议重新开始对话以体验新功能

---

## v2.1.1 - 2026-01-06

### 改进

本次更新基于用户反馈，进行了三项重要改进，显著提升了对话质量和用户体验。

#### 1. 全局对话理解优化 ⭐核心改进

**问题**：角色只回应上一条消息，缺乏对整体对话的理解和统筹能力

**解决方案**：
- 全面优化 AI Prompt 工程，强调"统揽全局，理解整体对话走向"
- 角色现在能够：
  - 回应任何一个角色的发言（不仅仅是最后一个人）
  - 对之前提到的话题进行补充或延伸
  - 综合多个人的观点给出自己的看法
  - 根据整体对话氛围自然表达
  - 提出与对话相关的新想法

**效果**：
- 对话连贯性大幅提升
- 角色表现更加智能和自然
- 多角色互动更加真实，不再是简单的"接龙"式回复

#### 2. 角色性格输入体验优化

**问题**：单行 `text_input` 输入框在输入较长性格描述时显示不全

**解决方案**：
- 将角色性格输入框从 `text_input` 改为 `text_area`
- 设置合适的高度（80px），支持多行输入
- 更新 placeholder 提示，提供更详细的示例

**效果**：
- 用户可以输入更详细的角色性格描述
- 文字完整显示，不会被截断
- 更好的输入体验和可视性

#### 3. 全局记忆功能 🎉新特性

**新增功能**：支持保存和加载完整对话会话

**保存对话**：
- 一键导出完整对话到 JSON 文件
- 包含所有数据：场景、角色、群聊历史、私聊历史
- 文件名自动添加时间戳（格式：`conversation_YYYYMMDD_HHMMSS.json`）
- 包含版本号标记，便于未来兼容性管理

**加载对话**：
- 通过文件上传器加载之前保存的对话
- 完整恢复所有状态和历史记录
- 支持跨会话持久化，解决了刷新页面丢失对话的问题

**技术实现**：
- 新增 `save_conversation_to_json()` 函数
- 新增 `load_conversation_from_json()` 函数
- 侧边栏新增"💾 全局记忆"功能区
- 使用 JSON 格式存储，易于阅读和调试

### 技术细节

**修改的函数**：
- `generate_single_reply_with_gemini()`: 优化 prompt，增强全局理解能力
- 角色设置界面：将性格输入从 `text_input` 改为 `text_area`

**新增函数**：
- `save_conversation_to_json()`: 保存对话状态为 JSON
- `load_conversation_from_json()`: 从 JSON 恢复对话状态

**新增依赖**：
- `json`: 数据序列化
- `datetime`: 时间戳生成

**UI 改进**：
- 侧边栏新增"💾 全局记忆"区域
- 保存按钮（对话开始后可用）
- 文件上传器（支持 .json 文件）

### 对比 v2.1.0

| 特性 | v2.1.0 | v2.1.1 |
|------|--------|--------|
| 对话理解范围 | 基于最近对话 | 全局理解、统筹把握 |
| 角色性格输入 | 单行输入框 | 多行文本框 |
| 对话持久化 | 仅会话内保存 | 支持导出/导入 JSON |
| 跨会话恢复 | ❌ | ✅ |

### 已知限制

- 对话历史较长时，API 调用的上下文长度可能受限（目前取最近 15 条）
- 加载的对话文件必须是本应用导出的格式

---

## v2.1.0 - 2026-01-06

### 重大更新

对话生成机制全面升级，从批量生成改为顺序发言，对话质量和真实感大幅提升。

### 新增功能

#### 1. 可变角色数量
- 支持 2-8 个角色，用户可自由调整
- 动态角色输入界面，自动调整布局
- 添加/减少角色按钮，操作简单直观
- 打破了固定3个角色的限制，提供更大的创作自由

#### 2. 顺序发言机制 ⭐核心特性
- **角色依次发言**：每个角色在前一个角色发言后才开始说话
- **上下文连贯**：后发言的角色能看到并回应前面角色的内容
- **对话更真实**：模拟真实群聊的交流方式，告别生硬的批量生成
- **初始对话也顺序生成**：从第一句话开始就是自然的对话流

#### 3. 实时状态提示
- 显示"🤔 角色名 正在思考..."的状态提示
- 显示生成进度："(1/5)"、"(2/5)"等
- 实时更新对话显示，让用户看到角色逐个发言
- 提升用户等待体验

### 改进

#### 核心算法优化
- 创建 `generate_single_reply_with_gemini()` 和 `mock_generate_single_reply()` 函数
- 每个角色的发言独立生成，基于最新的完整对话历史
- Prompt 优化，让 AI 更好地理解对话上下文和角色关系

#### UI/UX 改进
- 角色输入框自动分行，支持 2-8 个角色的清晰布局
- 状态提示友好，让用户清楚了解生成进度
- 初始对话生成后显示成功提示："✅ 初始对话生成完成！"

### 技术细节

**新增/修改的函数**
- `mock_generate_single_reply()`: Mock 单个角色发言
- `generate_single_reply_with_gemini()`: Gemini API 单个角色发言
- `init_session_state()`: 新增 `num_characters` 状态管理
- 主界面逻辑：完全重构对话生成流程

**状态管理**
- `num_characters`: 当前角色数量（2-8）

**Prompt 工程**
- 区分初始对话和续写对话的 prompt
- 明确告知 AI 对话历史和其他角色的发言
- 强调要回应前面的内容，保持对话连贯性

### 对比 v2.0.0

| 特性 | v2.0.0 | v2.1.0 |
|------|--------|--------|
| 角色数量 | 固定3个 | 2-8个可变 |
| 发言方式 | 批量生成 | 顺序发言 |
| 对话连贯性 | 一般 | 优秀 |
| 状态提示 | 简单的 spinner | 详细的进度提示 |
| 初始对话 | 批量生成 | 顺序生成 |

### 已知限制

- 角色越多，等待时间越长（顺序生成的代价）
- 对话历史仍然仅保存在当前会话中
- 私聊和群聊的记忆未同步（计划v2.2.0实现）

---

## v2.0.0 - 2026-01-06

### 重大更新

这是一个重大版本更新，从单向对话生成器升级为交互式群聊应用。

### 新增功能

#### 1. 交互式群聊模式
- 用户可以在初始对话生成后，实时参与群聊
- 输入消息后，所有角色会根据场景和性格做出回应
- 支持持续对话，形成真正的交互式体验
- 使用聊天界面 UI，提供更好的用户体验

#### 2. 私聊模式
- 新增私聊模式，支持与任意角色进行1对1对话
- 在侧边栏可以快速切换群聊/私聊模式
- 每个角色的私聊历史独立保存
- 私聊对话保持角色性格和场景背景

#### 3. 会话管理
- 使用 `session_state` 持久化对话状态
- 支持群聊历史和多个私聊历史的独立存储
- 添加"重新开始"功能，可以随时清空状态开始新对话

#### 4. 导出功能增强
- 支持导出群聊记录为文本文件
- 支持导出每个角色的私聊记录
- 导出格式清晰，便于保存和分享

### 改进

#### 架构优化
- 重构数据结构，采用消息列表格式存储对话
- 统一消息格式：`{speaker, content, type}`
- 为未来的"记忆同步"功能预留扩展空间

#### API 支持
- 完善 Mock 模式，提供更真实的模拟回复
- 新增三种 Gemini API 调用函数：
  - `generate_initial_conversation_with_gemini`: 生成初始对话
  - `generate_group_reply_with_gemini`: 生成群聊回复
  - `generate_private_reply_with_gemini`: 生成私聊回复
- 优化 prompt 工程，提升对话质量

#### UI/UX 改进
- 采用 Wide 布局，提供更宽敞的视觉空间
- 使用 Streamlit 原生聊天组件，提升交互体验
- 侧边栏集成所有设置和模式切换
- 添加场景描述显示，保持上下文感知

### 技术细节

**新增函数**
- `init_session_state()`: 初始化会话状态
- `mock_generate_initial_conversation()`: Mock 初始对话生成
- `mock_generate_group_reply()`: Mock 群聊回复生成
- `mock_generate_private_reply()`: Mock 私聊回复生成
- `render_chat_message()`: 渲染聊天消息

**状态管理**
- `chat_mode`: 对话模式（群聊/私聊）
- `scene`: 场景描述
- `characters`: 角色列表
- `group_chat_history`: 群聊历史
- `private_chat_history`: 私聊历史字典
- `selected_character`: 当前选中的私聊角色
- `conversation_started`: 对话是否已开始

### 兼容性

- Python 3.7+
- Streamlit >= 1.28.0
- google-genai >= 0.1.0

### 已知限制

- 群聊和私聊的记忆暂未同步（计划在后续版本实现）
- 对话历史仅保存在当前会话中，刷新页面会丢失
- 角色数量固定为3个

---

## v1.0.0 - 2025-12-30

### 初始版本

- 基础的对话生成功能
- 支持设置场景和3个角色
- 生成2轮预设对话
- 支持 Mock 模式和 Gemini API
- 基础的文本导出功能
